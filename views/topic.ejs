<!--
topic parameter
{
 title: string;
 lastBump: Date;
 accessCount: number;
 posts: {
   author: ObjectId;
   created: Date;
   body: string;
 }[];
 subscribers: ObjectId[];
}
-->

<!DOCTYPE html>
<html lang="en">
<head>
    <%- include('head') %>
    <script>
        function subscribe(postId) {
            fetch(`/subscribe/${postId}`, {
                method: "POST"
            }).then(() => {
                location.reload();
            }).catch(alert);
        }

        function unsubscribe(postId) {
            fetch(`/unsubscribe/${postId}`, {
                method: "POST"
            }).then(() => {
                location.reload();
            }).catch(alert);
        }
    </script>
</head>
    <body>
        <%- include('header') %>
        <div>
            <h1><%= topic.title %>
            <% if (!topic.subscribers.find(x => user._id.equals(x))) { %> <button type="submit" onclick='subscribe("<%= topic._id %>")''>Subscribe</button>
            <% } else { %> <button type="submit" onclick='unsubscribe("<%= topic._id %>")''>Unsubscribe</button> <% } %>
            </h1>
        </div>
        <p>Time created: <%= intl.format(topic.lastBump) %></p>
        <p>Views: <%= topic.accessCount %></p>
        <% topic.posts.forEach(post => { %>
         <fieldset>
            <legend><%= topic.users.find(x => x._id.equals(post.author))?.username %></legend>
            <%= post.body %>
         </fieldset>
        <% }) %>
        
        <form action="/topic/<%= topic._id %>/post" method="post">
            <div>
                <label>Make a Post</label>
                <button type="submit">Send</button>
            </div>
            <div>
                <textarea name="body"></textarea>
            </div>
        </form>
        
    </body>
</html>